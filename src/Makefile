GIT      = git
RM       = rm

CC       = gcc
LD       = $(CC)
CPPFLAGS = -I$(PWD)
CFLAGS   = -Wall -O0 -g
LDFLAGS  = 

OBJECTS = main.o child_info.o child_mem.o syscall.o path.o execve.o notice.o ureg.o interp.o

all: proot

######################################################################
# Beautified output

quiet_GEN = @echo "  GEN	$@"; $(GEN)
quiet_DEP = @echo "  DEP	$@"; $(CC)
quiet_CC  = @echo "  CC	$@"; $(CC)
quiet_LD  = @echo "  LD	$@"; $(LD)

VERBOSE = 0
ifeq ($(VERBOSE), 0)
    quiet = quiet_
    Q     = @
else
    quiet = 
    Q     = 
endif

######################################################################
# Auto-configuration

DEFAULT_VERSION = v0.6.1+

config.h:
	$($(quiet)GEN)
	$(Q)echo "/* This files is auto-generated by Makefile, do not edit. */" > $@
	$(Q)echo "#ifndef CONFIG_H" >> $@
	$(Q)echo "#define CONFIG_H" >> $@
	$(Q)sh -c 'VERSION=$$($(GIT) describe --tags --dirty --abbrev=8 --always 2>/dev/null); \
		echo "#define VERSION $${VERSION-$(DEFAULT_VERSION)}" >> $@'
	$(Q)sh -c 'echo -e "#include <stdlib.h>\nint main(void) { return readlinkat(0, NULL, NULL, 0); }" > conftest.c; \
		$(CC) conftest.c -o /dev/null 2>/dev/null; \
		if [ $$? -eq 0 ]; then \
			echo "#define HAVE_READLINKAT" >> $@; \
		fi; \
		rm conftest.c'
	$(Q)echo "#endif /* CONFIG_H */" >> $@

SRC   = $(dir $(firstword $(MAKEFILE_LIST)))/

######################################################################
# Build rules

proot: $(OBJECTS)
	$($(quiet)LD) $(LDFLAGS) $^ -o $@

%.o: %.d
	$($(quiet)CC) $(CPPFLAGS) $(CFLAGS) -c $(SRC)/$*.c -o $@

%.d: %.c
	$($(quiet)DEP) $(CPPFLAGS) $(CFLAGS) -M -MT '$*.o $*.d' -MG $(SRC)/$*.c -MF $@

######################################################################
# Dependancies

DEPS = $(OBJECTS:.o=.d)

.DELETE_ON_ERROR:
$(OBJECTS) $(DEPS) config.h: Makefile

ifneq ($(MAKECMDGOALS), clean)
    ifneq (,$(filter clean, $(MAKECMDGOALS)))
        $(error The target "clean" shall be invoked separately)
    else
        -include $(DEPS)
    endif
endif

######################################################################
# PHONY targets

.PHONY: clean
clean:
	$(RM) -f $(OBJECTS) proot $(DEPS) config.h
